---
title: Firestoreì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°, useEffectì˜ cleanup
date: 2024-01-25
description: onSnapshot ë©”ì„œë“œ ì‚¬ìš©í•˜ê¸°, useEffect cleanup í•¨ìˆ˜ì˜ ì—­í• 
category: react
---

## 1. useCollection hook ë§Œë“¤ê¸°

```jsx
import {
  collection,
  onSnapshot,
  query,
  where,
  orderBy,
} from "firebase/firestore";
import { useEffect, useState } from "react";
import { appFireStore } from "../firebase/config";

export const useCollection = (transition, myQuery) => {
  const [documents, setDocuments] = useState(null);
  const [error, setError] = useState(null);

  useEffect(() => {
    let q;
    if (myQuery) {
      q = query(
        collection(appFireStore, transition),
        where(...myQuery),
        orderBy("createdTime", "desc")
      );
    }
    const unsubscribe = onSnapshot(
      myQuery ? q : collection(appFireStore, transition),
      (snapshot) => {
        console.log(snapshot, "snapshotì€ ë°°ì—´ í˜•íƒœë¡œ ì €ìž¥ë˜ì–´ ìžˆë‹¤.");
        let result = [];

        snapshot.docs.forEach((doc) => {
          result.push({ ...doc.data(), id: doc.id });
        });

        console.log(result, "result ?");

        setDocuments(result);
        setError(null);
      },
      (error) => {
        setError(error.message);
      }
    );
    return unsubscribe;
  }, [collection]);

  return { documents, error };
};
```

### 1) ê³µì‹ë¬¸ì„œ ì‚¬ìš© ì˜ˆì‹œ

[ðŸ‘‰ðŸ»Â ê³µì‹ë¬¸ì„œ ë°”ë¡œê°€ê¸°](https://firebase.google.com/docs/firestore/query-data/listen)

![firestore ê³µì‹ë¬¸ì„œ](/images/blog/firestore_onsnapshot_01.png)

ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë ¤ë©´, onSnapshot() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

### 2) onSnapshot ì˜ ì¸ìž

- `collection(appFirestore, transition)`, : Firestore ì»¬ë ‰ì…˜ì— ëŒ€í•œ ì°¸ì¡°
- `(snapshot) â‡’ {}`, : ìŠ¤ëƒ…ìƒ· ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì½œë°±í•¨ìˆ˜
  - firestoreì˜ ë°ì´í„°ê°€ ë³€ê²½ë  ë•Œ ì‹¤í–‰ë˜ëŠ” ì½œë°±í•¨ìˆ˜
  - snapshotì€ ê·¸ **ìˆœê°„**ì˜ ë°ì´í„° ìŠ¤ëƒ…ìƒ·ì„ ë‚˜íƒ€ë‚¸ë‹¤. (ê°€ìž¥ ìµœì‹ !ðŸ”¥)
- `(error) â‡’ {}` : ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì½œë°±í•¨ìˆ˜

### 3) consoleì˜ ê²°ê³¼

- ì²˜ìŒ firestoreì—ì„œ ë°›ì•„ì˜¤ëŠ” snapshotì˜ í˜•íƒœ
  ![console ê²°ê³¼](/images/blog/firestore_onsnapshot_02.png)
- ê°€ê³µí•œ ê²°ê³¼ result
  ![console ê²°ê³¼](/images/blog/firestore_onsnapshot_03.png)

### 4) error handling

- firestoreì—ì„œ ìžì²´ì ìœ¼ë¡œ ì—ëŸ¬ë¥¼ í—¨ë“¤ë§í•´ì£¼ê³  ìžˆë‹¤.

![firestore ê³µì‹ë¬¸ì„œ](/images/blog/firestore_onsnapshot_04.png)

## 2. useEffect cleanup ì˜ ì—­í• 

`return unsubscribe;`

```jsx
return () => {
  unsubscribe();
};
```

useEffectê°€ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ëŠ” cleanup í•¨ìˆ˜ì´ë‹¤.

ì´ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ì–¸ë§ˆìš´íŠ¸ë˜ê±°ë‚˜, ì˜ì¡´ì„± ë°°ì—´ì´ ë³€ê²½ë  ë•Œ ë¦¬ìŠ¤ë„ˆë¥¼ ì œëŒ€ë¡œ êµ¬ë…í•´ì œ(unsubscribe) í•˜ë„ë¡ ë³´ìž¥í•œë‹¤. ì´ë¥¼ í†µí•´ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ì™€ ë¶ˆí•„ìš”í•œ ë¦¬ì†ŒìŠ¤ ì†Œëª¨ë¥¼ ë°©ì§€í•  ìˆ˜ ìžˆë‹¤.

ë”°ë¼ì„œ, `unsubscribe` í•¨ìˆ˜ëŠ” Firestore ì»¬ë ‰ì…˜ì˜ ë³€ê²½ì‚¬í•­ì„ ë”ì´ìƒ ê°ì§€í•  í•„ìš”ê°€ ì—†ì„ë•Œ ë¦¬ìŠ¤ë„ˆë¥¼ ì¤‘ì§€ì‹œí‚¤ëŠ”ë° ì‚¬ìš©ëœë‹¤.

## 3. useCollection hook ì‚¬ìš©í•˜ê¸°

- Home ì»´í¬ë„ŒíŠ¸

```jsx
const Home = () => {
  //..
  const { documents, error } = useCollection("diary");
  return (
    <main className={styles.cont}>
      <aside className={styles.side_menu}>
        <DiaryForm uid={user.uid} />
      </aside>
      <ul className={styles.content_list}>
        {error && <strong>{error}</strong>}
        {documents && <DiaryList diaries={documents} />}
      </ul>
    </main>
  );
};

export default Home;
```

- DiaryList ì»´í¬ë„ŒíŠ¸

```jsx
const DiaryList = ({ diaries }) => {
  //..
  return (
    <>
      {diaries.map((item) => {
        return (
          <li key={item.id}>
            <strong className={styles.title}>{item.title}</strong>
            <p className={styles.text}>{item.text}</p>
            <button onClick={() => deleteDocument(item.id)}>X</button>
          </li>
        );
      })}
    </>
  );
};

export default DiaryList;
```
